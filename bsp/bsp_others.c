//=====================
//一些没有接口函数底层驱动封装
//主要是运行在后台
//=====================
#include "bsp_others.h"
#include "misc.h"
#include "rcc.h"
#include "address.h"
#include "adc.h"
#include "sys.h"
#include "delay.h"

//========================================
//10k 3950 NTC 热电阻分度表
//单位 欧*10000
//========================================
#if TEMPERATURE_TYPE == 2
static const int32_t tempTable3950_10K[][2] = {

{-40 ,3409281},		
{-39,	3188772},	
{-38,	2983978},	
{-37,	2793683},	
{-36,	2616769},	
{-35,	2452212},	
{-34,	2299072},	
{-33,	2156488},	
{-32,	2023666},	
{-31,	1899878},
{-30,	1784456},	
{-29,	1676783},	
{-28,	1576292},	
{-27,	1482460},	
{-26,	1394807},	
{-25,	1312888},	
{-24,	1236294},	
{-23,	1164648},	
{-22,	1097600},	
{-21,	1034829},	
{-20,	976037},	
{-19,	920947},	
{-18,	869305},	
{-17,	820877},	
{-16,	775442},	
{-15,	732798},	
{-14,	692759},	
{-13,	655149},	
{-12,	619809},	
{-11,	586587},	
{-10,	555345},	
{-9,	525954},	
{-8,	498294},	
{-7,	472253},	
{-6,	447727},	
{-5,	424620},	
{-4,	402841},	
{-3,	382307}, 
{-2,	362940},	
{-1,	344668},	
{0,		327421},	
{1,		311138},	
{2,		295759},	
{3,		281229},	
{4,		267496},	
{5,		254513},	
{6,		242234},	
{7,		230618},	
{8,		219625},	
{9,		209218},	
{10,	199364},	
{11,	190029},	
{12,	181184},	
{13,	172800},	
{14,	164852},	
{15,	157313},	
{16,	150161},	
{17,	143375},	
{18,	136932},	
{19,	130815},	
{20,	125005},	
{21,	119485},	
{22,	114239},	
{23,	109252},
{24,	104510},
{25,	100000},
{26,	95709},	
{27,	91626},	
{28,	87738},	
{29,	84037},	
{30,	80512},
{31,	77154},	
{32,	73954},	
{33,	70904},
{34,	67996},
{35,	65223},	
{36,	62577},	
{37,	60053},	
{38,	57645},
{39,	55345},	
{40,	53150},	
{41,	51053},	
{42,	49050},
{43,	47136},	
{44,	45307},	
{45,	43558},	
{46,	41887},	
{47,	40287},	
{48,	38758},
{49,	37294},	
{50,	35893},
{51,	34553},	
{52,	33269},	
{53,	32039},	
{54,	30862},	
{55,	29733},	
{56,	28652},	
{57,	27616},	
{58,	26622},	
{59,	25669},	
{60,	24755},	
{61,	23879},
{62,	23038},	
{63,	22231},	
{64,	21456},	
{65,	20712},	
{66,	19998},	
{67,	19312},	
{68,	18653},	
{69,	18019},	
{70, 	17411},
{71,	16826},
{72,	16264},
{73,	15723},
{74,	15203},
{75,	14703},
{76,	14222},
{77,	13759},
{78,	13313},
{79,	12884},
{80,	12471},
{81,	12073},
{82,	11690},
{83,	11321},
{84,	10965},
{85,	10623},
{86,	10293},
{87,	9974},
{88,	9667},
{89,	9372},
{90,	9086},
{91,	8811},
{92,	8545},
{93,	8289},
{94,	8042},
{95,	7803},
{96,	7572},
{97,	7350},
{98,	7135},
{99,	6927},
{100,	6727},
{101,	6533},
{102,	6346},
{103,	6165},
{104,	5990},
{105,	5821},

};
#endif


/*
易触的在用
这个值 = 欧*1000
*/
#if TEMPERATURE_TYPE == 1
static const int32_t tempTable3470_5K[][2] = {

{-40,	113110},
{-39,	105970},
{-38,	99500},
{-37,	93610},
{-36,	88230},
{-35,	83280},
{-34,	78720},
{-33,	74480},
{-32,	70540},
{-31,	66860},
{-30,	63410},
{-29,	60590},
{-28,	57760},
{-27,	54970},
{-26,	52240},
{-25,	49580},
{-24,	47010},
{-23,	44550},
{-22,	42190},
{-21,	39960},
{-20,	37830},
{-19,	35930},
{-18,	34120},
{-17,	32390},
{-16,	30750},
{-15,	29180},
{-14,	27700},
{-13,	26280},
{-12,	24940},
{-11,	23660},
{-10,	22450},
{-9,	21390},
{-8,	20400},
{-7,	19470},
{-6,	18600},
{-5,	17780},
{-4,	17010},
{-3,	16290},
{-2,	15600},
{-1,	14960},
{0,	14350},
{1,	13710},
{2,	13100},
{3,	12520},
{4,	11970},
{5,	11450},
{6,	10950},
{7,	10480},
{8,	10030},
{9,	9610},
{10,	9200},
{11,	8810},
{12,	8450},
{13,	8100},
{14,	7760},
{15,	7450},
{16,	7140},
{17,	6860},
{18,	6580},
{19,	6320},
{20,	6070},
{21,	5830},
{22,	5610},
{23,	5390},
{24,	5180},
{25,	4980},
{26,	4730},
{27,	4540},
{28,	4370},
{29,	4210},
{30,	4050},
{31,	3900},
{32,	3750},
{33,	3610},
{34,	3480},
{35,	3350},
{36,	3230},
{37,	3120},
{38,	3010},
{39,	2900},
{40,	2800},
{41,	2700},
{42,	2610},
{43,	2520},
{44,	2430},
{45,	2350},
{46,	2270},
{47,	2190},
{48,	2120},
{49,	2050},
{50,	1980},
{51,	1910},
{52,	1850},
{53,	1790},
{54,	1730},
{55,	1680},
{56,	1630},
{57,	1570},
{58,	1520},
{59,	1480},
{60,	1430},
{61,	1390},
{62,	1340},
{63,	1300},
{64,	1260},
{65,	1220},
{66,	1190},
{67,	1150},
{68,	1120},
{69,	1080},
{70,	1050},
{71,	1020},
{72,	990},
{73,	960},
{74,	930},
{75,	910},
{76,	880},
{77,	860},
{78,	830},
{79,	810},
};
#endif

/*
金码温控头
这个值 = 欧*10000
Resistance	2.5k Ohms at 25deg. C 
B Value		470K at 25/50 deg. C 
*/
#if TEMPERATURE_TYPE == 0
static const int32_t tempTable3470_2_5K[][2] = {
	
{-40	,554979},
{-39	,523231},
{-38	,493515},
{-37	,465689},
{-36	,439621},
{-35	,415187},
{-34	,392275},
{-33	,370781},
{-32	,350608},
{-31	,331666},
{-30	,313873},
{-29	,297151},
{-28	,281430},
{-27	,266643},
{-26	,252729},
{-25	,239632},
{-24	,227297},
{-23	,215677},
{-22	,204726},
{-21	,194400},
{-20	,184661},
{-19	,175471},
{-18	,166797},
{-17	,158606},
{-16	,150869},
{-15	,143557},
{-14	,136645},
{-13	,130109},
{-12	,123925},
{-11	,118074},
{-10	,112535},
{-9	,107289},
{-8	,102320},
{-7	,97611},
{-6	,93147},
{-5	,88914},
{-4	,84899},
{-3	,81089},
{-2	,77473},
{-1	,74040},
{0	,70779},
{1	,67681},
{2	,64737},
{3	,61938},
{4	,59276},
{5	,56744},
{6	,54335},
{7	,52042},
{8	,49859},
{9	,47781},
{10	,45800},
{11	,43913},
{12	,42115},
{13	,40400},
{14	,38765},
{15	,37206},
{16	,35717},
{17	,34297},
{18	,32941},
{19	,31646},
{20	,30409},
{21	,29228},
{22	,28098},
{23	,27019},
{24	,25987},
{25	,25000},
{26	,24056},
{27	,23153},
{28	,22288},
{29	,21460},
{30	,20668},
{31	,19909},
{32	,19182},
{33	,18485},
{34	,17818},
{35	,17178},
{36	,16564},
{37	,15976},
{38	,15411},
{39	,14870},
{40	,14350},
{41	,13851},
{42	,13372},
{43	,12912},
{44	,12471},
{45	,12046},
{46	,11639},
{47	,11247},
{48	,10870},
{49	,10508},
{50	,10160},
{51	,9825},
{52	,9503},
{53	,9193},
{54	,8895},
{55	,8607},
{56	,8331},
{57	,8065},
{58	,7809},
{59	,7562},
{60	,7324},
{61	,7094},
{62	,6874},
{63	,6661},
{64	,6455},
{65	,6257},
{66	,6066},
{67	,5882},
{68	,5704},
{69	,5533},
{70	,5367},
{71	,5208},
{72	,5053},
{73	,4905},
{74	,4761},
{75	,4622},
{76	,4488},
{77	,4358},
{78	,4233},
{79	,4112},

};
#endif

//采用折半查找
int temp_chk(uint32_t res)
{
	const int32_t (*table)[2];//指向二维数组的指针
	uint16_t last, beg = 0,mid = 0, limit;
	
	#if TEMPERATURE_TYPE == 0
			last = sizeof(tempTable3470_2_5K)/8;
			res *= 10;//放大10倍,3470_2.5k 电阻单位是 k欧*10
			table = tempTable3470_2_5K;
	#endif
	
	#if TEMPERATURE_TYPE == 1
			last = sizeof(tempTable3470_5K)/8;
			table = tempTable3470_5K;
	#endif
	
	#if TEMPERATURE_TYPE == 2
			last = sizeof(tempTable3950_10K)/8;
			res *= 10;//放大10倍,3950_10k 电阻单位是 k欧*10
			table = tempTable3950_10K;
	#endif
	
//	switch(g_temperatureType)
//	{
//		case 2:
//			last = sizeof(tempTable3950_10K)/8;
//			res *= 10;//放大10倍,3950_10k 电阻单位是 k欧*10
//			table = tempTable3950_10K;
//		break;
//		case 1:
//			last = sizeof(tempTable3470_5K)/8;
//			table = tempTable3470_5K;
//		break;
//		case 0:
//			last = sizeof(tempTable3470_2_5K)/8;
//			res *= 10;//放大10倍,3470_2.5k 电阻单位是 k欧*10
//			table = tempTable3470_2_5K;
//		break;
//		default :
//			return 255;
//	}
	/*
	也可以人为限制有效温度范围（设置beg与last）
	*/
	limit = last;//做限制使用
   
	while(beg <= last)  
    {  
		mid = (beg + last) / 2;  
		if(mid >= limit) 
			return 255;
        if (res == table[mid][1] || (table[mid][1] > res && table[mid+1][1] < res)) 
        {  
			return table[mid][0]; 
        }  
        else 
		if (table[mid][1] > res)  
        {  
			beg = mid + 1;
        }  
        else 
		if (table[mid][1] < res)  
        {  
            last = mid - 1;
        }  
    }  
    return 255;  //表示错误，没有这个值
	
}
//========================================
//中断组配置
//说明：使用中断组1
//1位先占优先级，3位次优先级
//========================================
static void NVIC_group_config(void)
{
	//中断优先级分组
	NVIC_PriorityGroupConfig(NVIC_PriorityGroup_1);//2个先占优先级0，1；8个
}

//=======================================
//系统时钟初始化，库文件本身自带
//用户时钟初始化，用户可以自己修改
//中断分组初始化，选择系统所用的中断分组
//rtc时钟初始化
//地址配置初始化
//=======================================
void bsp_system_init(void)
{
	SystemInit();			//库文件定义
	user_rcc();				//用户自定义时钟
	NVIC_group_config();	//中断优先级分组
	addr_config();			//地址引脚初始化
}

//========================================
//地址查询
//========================================
void bsp_addr_check(void)
{
	uint8_t addr[4];
	get_board_addr(addr);
	sys_set_addr((addr[0] & 0x1) | ((addr[1] & 0x1) << 1) | ((addr[2] & 0x1) <<2 ) | ((addr[3] & 0x1) << 3));
	
}

uint16_t temp1,temp2,tempeture;
uint16_t tmp1[5],tmp2[5];
//========================================
//检测当前温度
//========================================
void  bsp_temp_check(void)
{	
	uint32_t i, value[2];
	uint32_t max, min;
	
	get_adc45_value(&tmp1[0], &tmp2[0]);
	delay_ms(50);
	get_adc45_value(&tmp1[1], &tmp2[1]);
	delay_ms(50);
	get_adc45_value(&tmp1[2], &tmp2[2]);
	delay_ms(50);
	get_adc45_value(&tmp1[3], &tmp2[3]);
	delay_ms(50);
	get_adc45_value(&tmp1[4], &tmp2[4]);
	
	for(i = 0; i < 5; i++)
	{
		if(i == 0)
		{
			max = tmp1[i];
			min = tmp1[i];
		}
		else
		{
			if(tmp1[i] >= max)
			{
				max = tmp1[i];
			}
			if(tmp1[i] <= min)
			{
				min = tmp1[i];
			}
		}
	}
	temp1 = (tmp1[0] + tmp1[1] + tmp1[2] + tmp1[3] + tmp1[4] - max - min) / 3;
	
//	for(i = 0; i < 5; i++)
//	{
//		if(tmp1[i%5] > tmp1[(i + 1)%5])
//		
//	}
	
	for(i = 0; i < 5; i++)
	{
		if(i == 0)
		{
			max = tmp2[i];
			min = tmp2[i];
		}
		else
		{
			if(tmp2[i] >= max)
			{
				max = tmp2[i];
			}
			if(tmp2[i] <= min)
			{
				min = tmp2[i];
			}
		}
	}
	temp2 = (tmp2[0] + tmp2[1] + tmp2[2] + tmp2[3] + tmp2[4] - max - min) / 3;
//	get_adc45_value(&temp1,&temp2);
//	temp1 = (temp1 + temp3)/2;
//	temp2 = (temp2 + temp4)/2;
	//计算温度值
	if(temp1 < 50)
	{
		value[0] = 0;
		temp_set_state(0,TEMP_STATE_NOINSTALL);
	}
	else
	{
		value[0] = 10000*4095/temp1-10000;//阻值
		if(tempeture != 0)
		{
			tempeture = (tempeture + temp_chk(value[0]))/2;
		}
		else
		{
			tempeture = temp_chk(value[0]);
		}
		temp_set_value(0, tempeture);
		temp_set_state(0, TEMP_STATE_NORMAL);

	}
	
	if(temp2 < 50)
	{	
		value[1] = 0;
		temp_set_state(1,TEMP_STATE_NOINSTALL);
	}
	else//未安装
	{
		value[1] = 10000*4095/temp2-10000;//
		temp_set_value(1, temp_chk(value[1]));
		temp_set_state(1, TEMP_STATE_NORMAL);
	}
	
	
	//这里也用回调函数处理得了
//	temp_set_value(0,temp_chk(value[0]));
//	temp_set_value(1,temp_chk(value[1]));
	
	
	//可以根据温度值来判断温度是否正常
	//一般认为小于 -10度 大于 70度，温度探头异常
	if(temp_get_value(0) < -10 || temp_get_value(0) > 70)
		temp_set_state(0,TEMP_STATE_ERR);
	if(temp_get_value(1) < -10 || temp_get_value(1) > 70)
		temp_set_state(1,TEMP_STATE_ERR);
	
}

